<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <title>Unknown Tool</title>
  </head>
  <body>
    <div class="container">
        <h1>Unknown Tool</h1>

        <div class="alert" id="alertMsg" role="alert"></div>

        <div class="card" id="serverFormDiv">
            <h5 class="card-header">Server Details</h5>
            <form id="serverForm">
                <div class="card-body">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                              <label>Server Name</label>
                              <input type="text" name="servername" class="form-control" placeholder="Server Name" required>
                            </div>
                            <div class="form-group col-md-4">
                              <label>User Name</label>
                              <input type="text" name="username" class="form-control" placeholder="User Name" required>
                            </div>
                            <div class="form-group col-md-4">
                              <label>Password</label>
                              <input type="password" name="password" class="form-control" placeholder="Password" required>
                            </div>
                          </div>
                </div>
                <div class="card-footer">
                    <button id="saveServerDetails" class="btn btn-primary float-right">Save</button>
                </div>
            </form>
        </div>
        
        <br/>

    
        <div class="card" id="serverList">
            <h5 class="card-header"> Server List
                 <button class="serverFormDivBtn btn btn-primary float-right" title="Add Server"><i class="fa fa-plus" aria-hidden="true"></i></button>
             </h5>
            <div class="card-body">

            <table id="example" class="display table table-bordered " style="width:100%">
                <thead>
                    <tr>
                        <th>Server Name</th>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        </div>

        <br/>
        
        <div class="card">
            <h5 class="card-header"> Server Info
                 <button class="serverFormDivBtn btn btn-primary float-right" title="Add Server"><i class="fa fa-plus" aria-hidden="true"></i></button>
             </h5>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
     <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
     <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script>
        // DB
        var db = new Dexie('tintri_tool');
        db.version(1).stores({
             vmstores: 'servername,username,password'
        });
        db.open().catch(function (err) {
            console.error (err.stack || err);
        });

        // VMStore
        var VMStore = db.vmstores.defineClass ({
            servername: String,
            username: String,
            password: String
        })
        VMStore.prototype.log = function (){
            console.log("I am from Class");
            console.log(JSON.stringify(this));
        }

        // Get VMStores Item
        // db.vmstores.get('tboltsr23', function(item){
        //     item.log();
        // });

        // Get All VMStores Item
        // db.vmstores.toCollection().toArray(function(c){

        //     console.log(c)
        // });

        // Insert Bulk VMStore
        // var dataInsert = [
        //     {servername: "tboltsr25", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr26", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr27", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr28", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr29", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr21", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr22", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr23", username: 'admin', password:'tintri99'},
        //     {servername: "tboltsr24", username: 'admin', password:'tintri99'}

        // ];
        // db.vmstores.bulkAdd(dataInsert)
        // .then(function(e){
        //     console.log(e);
        // });

        // Insert VMStore
        // db.vmstores.add({servername: "tboltsr23", username: 'admin', password:'tintri99'})
        // .then(function(e){
        //     console.log(e);
        // });

        // Update VMStores
        // db.vmstores.update("tboltsr23", {username: 'admin', password:'tintri99'})
        // .then(function(e){
        //     console.log(e);
        // });

        // Delete VMStores
        // db.vmstores.delete("tboltsr23").
        // then(function(e){
        //      // console.log(e);
        //      e.log();
        // });
        
        
        // Get VMStores Item
        // db.vmstores.get('tboltsr23', function(item){
        //     console.log(item);
        // });


        $("#serverFormDiv").hide();

        // List Server Details
        var serverTable = $('#example').DataTable({
            ajax: function(data, callback,settings){
                db.vmstores.toCollection()
                .toArray(function(d){
                    callback(d);
                });
                settings.sAjaxDataProp = '';
            },
            "columns": [
                { "data": "servername" },
                { "data": "username" },
                { "data": "password" }
            ],
            "columnDefs": [
                {
                    'targets':3,
                    "render": function ( data, type, row ) {

                        btn = '<div class="btn-group" role="group">';
                        btn += '<a href="#" data-servername="'+row['servername']+'" class="viewServer btn btn-info"><i class="fa fa-eye" aria-hidden="true"></i></a>';
                        btn += '<a href="#" data-servername="'+row['servername']+'" class="serverFormDivBtn editServer btn btn-warning"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a>';
                        btn += '<a href="#" data-servername="'+row['servername']+'" class="removeServer btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i></a>';
                        btn += '</div>';
                        return btn;
                    }
                }
            ]   
        });

        function alertMsg(message, status){

            $("#alertMsg").removeClass().addClass(" alert alert-"+status).html(message).show();
            setTimeout(function(){ 
                $("#alertMsg").hide();
             }, 3000);
        }

        // Insert Server Details
        $(document).on('click', ".serverFormDivBtn", function(e){
            if(!$("#serverFormDiv").is(":visible")){
               $("#serverFormDiv").show();
            }
        });

        $(document).on('submit', "form#serverForm", function(e){
            e.preventDefault(e);
            return false;
        })


        $(document).on('click', '#saveServerDetails',function(e){
            var form = $("form#serverForm");

            if(form[0].checkValidity()){
                var arrayData = form.serializeArray();
                var jsonData = {};

                $.map(arrayData, function(n, i){
                    jsonData[n['name']] = n['value'];
                });

                db.vmstores.put(jsonData)
                .then(function(e){
                    $("#serverFormDiv").hide();
                    form[0].reset();
                    serverTable.ajax.reload();
                    alertMsg("Server Details Saved Successfully","success");
                });
            }
            alertMsg("Please fill all the details","danger");
        });
        

        $(document).on('click', '.editServer', function(){
            servername = $(this).attr('data-servername');

            db.vmstores.get(servername, function(item){

                $.each(item, function(key, value) {  
                    var ctrl = $('[name='+key+']', $("form#serverForm"));  
                    switch(ctrl.prop("type")) { 
                        case "radio": case "checkbox":   
                            ctrl.each(function() {
                                if($(this).attr('value') == value) $(this).attr("checked",value);
                            });   
                            break;  
                        default:
                            ctrl.val(value); 
                    }  
                });  
            });
        });

        // Delete Server Details
        $(document).on('click', ".removeServer", function(e){
            servername = $(this).attr('data-servername');
            // Delete VMStores
            db.vmstores.delete(servername).
            then(function(e){
                db.vmstores.get(servername, function(item){
                    if(typeof item === 'undefined'){
                        alertMsg(servername + " Removed Successfully", "success");
                        serverTable.ajax.reload();
                    }
                    else{
                        alertMsg(servername + " Removed Failed", "danger");
                    }
                });
            });
        });

    </script>
  </body>
</html>
